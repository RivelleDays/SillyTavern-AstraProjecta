import { __iconNode as AsteriskIconNode } from 'lucide-react/dist/esm/icons/asterisk.js'
import { __iconNode as ArrowDown01IconNode } from 'lucide-react/dist/esm/icons/arrow-down-0-1.js'
import { __iconNode as ArrowDownAZIconNode } from 'lucide-react/dist/esm/icons/arrow-down-a-z.js'
import { __iconNode as ArrowLeftIconNode } from 'lucide-react/dist/esm/icons/arrow-left.js'
import { __iconNode as ArrowRightLeftIconNode } from 'lucide-react/dist/esm/icons/arrow-right-left.js'
import { __iconNode as BellRingIconNode } from 'lucide-react/dist/esm/icons/bell-ring.js'
import { __iconNode as BookLockIconNode } from 'lucide-react/dist/esm/icons/book-lock.js'
import { __iconNode as BookMarkedIconNode } from 'lucide-react/dist/esm/icons/book-marked.js'
import { __iconNode as BookmarkIconNode } from 'lucide-react/dist/esm/icons/bookmark.js'
import { __iconNode as BracesIconNode } from 'lucide-react/dist/esm/icons/braces.js'
import { __iconNode as BrainIconNode } from 'lucide-react/dist/esm/icons/brain.js'
import { __iconNode as CaseSensitiveIconNode } from 'lucide-react/dist/esm/icons/case-sensitive.js'
import { __iconNode as CheckIconNode } from 'lucide-react/dist/esm/icons/check.js'
import { __iconNode as ChevronRightIconNode } from 'lucide-react/dist/esm/icons/chevron-right.js'
import { __iconNode as ChevronsLeftIconNode } from 'lucide-react/dist/esm/icons/chevrons-left.js'
import { __iconNode as CircleArrowDownIconNode } from 'lucide-react/dist/esm/icons/circle-arrow-down.js'
import { __iconNode as CircleArrowUpIconNode } from 'lucide-react/dist/esm/icons/circle-arrow-up.js'
import { __iconNode as CircleCheckBigIconNode } from 'lucide-react/dist/esm/icons/circle-check-big.js'
import { __iconNode as CircleFadingArrowUpIconNode } from 'lucide-react/dist/esm/icons/circle-fading-arrow-up.js'
import { __iconNode as ContactIconNode } from 'lucide-react/dist/esm/icons/contact.js'
import { __iconNode as DatabaseZapIconNode } from 'lucide-react/dist/esm/icons/database-zap.js'
import { __iconNode as DownloadIconNode } from 'lucide-react/dist/esm/icons/download.js'
import { __iconNode as EllipsisIconNode } from 'lucide-react/dist/esm/icons/ellipsis.js'
import { __iconNode as ExpandIconNode } from 'lucide-react/dist/esm/icons/expand.js'
import { __iconNode as FlaskConicalIconNode } from 'lucide-react/dist/esm/icons/flask-conical.js'
import { __iconNode as FolderPenIconNode } from 'lucide-react/dist/esm/icons/folder-pen.js'
import { __iconNode as FolderXIconNode } from 'lucide-react/dist/esm/icons/folder-x.js'
import { __iconNode as IdCardLanyardIconNode } from 'lucide-react/dist/esm/icons/id-card-lanyard.js'
import { __iconNode as ImageIconNode } from 'lucide-react/dist/esm/icons/image.js'
import { __iconNode as ImagesIconNode } from 'lucide-react/dist/esm/icons/images.js'
import { __iconNode as InfoIconNode } from 'lucide-react/dist/esm/icons/info.js'
import { __iconNode as MessageCircleIconNode } from 'lucide-react/dist/esm/icons/message-circle.js'
import { __iconNode as MessageCircleMoreIconNode } from 'lucide-react/dist/esm/icons/message-circle-more.js'
import { __iconNode as MessagesSquareIconNode } from 'lucide-react/dist/esm/icons/messages-square.js'
import { __iconNode as FileTextIconNode } from 'lucide-react/dist/esm/icons/file-text.js'
import { __iconNode as HouseIconNode } from 'lucide-react/dist/esm/icons/house.js'
import { __iconNode as MinimizeIconNode } from 'lucide-react/dist/esm/icons/minimize.js'
import { __iconNode as PencilLineIconNode } from 'lucide-react/dist/esm/icons/pencil-line.js'
import { __iconNode as Plug2IconNode } from 'lucide-react/dist/esm/icons/plug-2.js'
import { __iconNode as PowerOffIconNode } from 'lucide-react/dist/esm/icons/power-off.js'
import { __iconNode as ReplaceIconNode } from 'lucide-react/dist/esm/icons/replace.js'
import { __iconNode as ReplaceAllIconNode } from 'lucide-react/dist/esm/icons/replace-all.js'
import { __iconNode as ScanFaceIconNode } from 'lucide-react/dist/esm/icons/scan-face.js'
import { __iconNode as SettingsIconNode } from 'lucide-react/dist/esm/icons/settings.js'
import { __iconNode as Settings2IconNode } from 'lucide-react/dist/esm/icons/settings-2.js'
import { __iconNode as ShieldAlertIconNode } from 'lucide-react/dist/esm/icons/shield-alert.js'
import { __iconNode as SlidersHorizontalIconNode } from 'lucide-react/dist/esm/icons/sliders-horizontal.js'
import { __iconNode as SmilePlusIconNode } from 'lucide-react/dist/esm/icons/smile-plus.js'
import { __iconNode as SparkleIconNode } from 'lucide-react/dist/esm/icons/sparkle.js'
import { __iconNode as SquareCheckBigIconNode } from 'lucide-react/dist/esm/icons/square-check-big.js'
import { __iconNode as StickyNoteIconNode } from 'lucide-react/dist/esm/icons/sticky-note.js'
import { __iconNode as TagsIconNode } from 'lucide-react/dist/esm/icons/tags.js'
import { __iconNode as TextAlignJustifyIconNode } from 'lucide-react/dist/esm/icons/text-align-justify.js'
import { __iconNode as TextSearchIconNode } from 'lucide-react/dist/esm/icons/text-search.js'
import { __iconNode as Trash2IconNode } from 'lucide-react/dist/esm/icons/trash-2.js'
import { __iconNode as TriangleAlertIconNode } from 'lucide-react/dist/esm/icons/triangle-alert.js'
import { __iconNode as TypeIconNode } from 'lucide-react/dist/esm/icons/type.js'
import { __iconNode as UploadIconNode } from 'lucide-react/dist/esm/icons/upload.js'
import { __iconNode as UserCogIconNode } from 'lucide-react/dist/esm/icons/user-cog.js'
import { __iconNode as UserPenIconNode } from 'lucide-react/dist/esm/icons/user-pen.js'
import { __iconNode as UsersIconNode } from 'lucide-react/dist/esm/icons/users.js'
import { __iconNode as WholeWordIconNode } from 'lucide-react/dist/esm/icons/whole-word.js'
import { __iconNode as WrenchIconNode } from 'lucide-react/dist/esm/icons/wrench.js'

const SVG_NAMESPACE = 'http://www.w3.org/2000/svg'

const DEFAULT_SVG_ATTRIBUTES = {
	xmlns: SVG_NAMESPACE,
	viewBox: '0 0 24 24',
	fill: 'none',
	stroke: 'currentColor',
	'stroke-linecap': 'round',
	'stroke-linejoin': 'round',
}

/**
 * @typedef {[string, Record<string, any>]} IconNodeEntry
 * @typedef {IconNodeEntry[]} IconNode
 */

/**
 * Converts camelCase or snake_case text into kebab-case.
 * @param {string} value
 * @returns {string}
 */
function toKebabCase(value) {
	return String(value)
		.replace(/([a-z0-9])([A-Z])/g, '$1-$2')
		.replace(/[\s_]+/g, '-')
		.toLowerCase()
}

/**
 * Normalizes className inputs (string or array) into an array of tokens.
 * @param {string|string[]|undefined|null} value
 * @returns {string[]}
 */
function normalizeClassName(value) {
	if (!value) return []
	if (Array.isArray(value)) return value.map(token => String(token).trim()).filter(Boolean)
	return String(value)
		.split(/\s+/)
		.map(token => token.trim())
		.filter(Boolean)
}

/**
 * @typedef {{ size?: number, strokeWidth?: number, className?: string|string[], attrs?: Record<string, any> }} IconOptions
 */

/**
 * Applies attributes to an SVG element.
 * @param {SVGElement} element
 * @param {Record<string, any>} attributes
 */
function applyAttributes(element, attributes) {
	for (const [key, rawValue] of Object.entries(attributes)) {
		if (rawValue === undefined || rawValue === null) continue
		if (key === 'class' && Array.isArray(rawValue)) {
			if (rawValue.length === 0) continue
			element.setAttribute('class', rawValue.join(' '))
			continue
		}
		if (key === 'style' && typeof rawValue === 'object' && !Array.isArray(rawValue)) {
			const styleValue = Object.entries(rawValue)
				.map(([prop, value]) => `${toKebabCase(prop)}:${String(value)}`)
				.join(';')
			if (styleValue) element.setAttribute('style', styleValue)
			continue
		}
		element.setAttribute(key, String(rawValue))
	}
}

/**
 * Creates an SVGElement from an IconNode.
 * @param {IconNode} iconNode
 * @param {IconOptions} [options]
 * @returns {SVGElement}
 */
function buildSvgFromIconNode(iconNode, options = {}) {
	const { size = 24, strokeWidth = 2, className, attrs = {} } = options
	const svgElement = document.createElementNS(SVG_NAMESPACE, 'svg')

	const classTokens = [
		...normalizeClassName(attrs.class ?? attrs.className),
		...normalizeClassName(className),
	]

	const svgAttributes = {
		...DEFAULT_SVG_ATTRIBUTES,
		...attrs,
	}

	if (!('width' in svgAttributes)) svgAttributes.width = size
	if (!('height' in svgAttributes)) svgAttributes.height = size
	if (!('stroke-width' in svgAttributes) && strokeWidth !== undefined && strokeWidth !== null) {
		svgAttributes['stroke-width'] = strokeWidth
	}

	if ('className' in svgAttributes) {
		classTokens.push(...normalizeClassName(svgAttributes.className))
		delete svgAttributes.className
	}
	if ('class' in svgAttributes) {
		classTokens.push(...normalizeClassName(svgAttributes.class))
	}
	if (classTokens.length > 0) {
		svgAttributes.class = Array.from(new Set(classTokens)).join(' ')
	} else {
		delete svgAttributes.class
	}

	const hasAccessibilityAttributes = Object.keys(svgAttributes).some(key => key === 'role' || key.startsWith('aria-'))
	if (!hasAccessibilityAttributes && !('aria-hidden' in svgAttributes)) {
		svgAttributes['aria-hidden'] = 'true'
	}

	applyAttributes(svgElement, svgAttributes)

	iconNode.forEach(([tag, nodeAttrs]) => {
		const child = document.createElementNS(SVG_NAMESPACE, tag)
		applyAttributes(child, nodeAttrs)
		svgElement.appendChild(child)
	})

	return svgElement
}

/**
 * Registry of icon nodes keyed by normalized identifiers.
 * @type {Map<string, IconNode>}
 */
const ICON_REGISTRY = new Map()

/**
 * Converts a string identifier into the canonical, lower-case hyphenated key.
 * Examples:
 *   'Brain'            -> 'brain'
 *   'brain-icon'       -> 'brain'
 *   'ArrowDown01'      -> 'arrowdown01'
 *   'arrow-down-a-z'   -> 'arrow-down-a-z'
 * @param {string} name
 * @returns {string}
 */
function toRegistryKey(name) {
	return String(name)
		.trim()
		.replace(/icon$/i, '')
		.replace(/[^a-z0-9]+/gi, '-')
		.replace(/^-+|-+$/g, '')
		.toLowerCase()
}

/**
 * Registers an icon node with one or more aliases.
 * @param {IconNode} iconNode
 * @param {string[]} aliases
 */
function registerIcon(iconNode, aliases) {
	for (const alias of aliases) {
		const key = toRegistryKey(alias)
		if (!key) continue
		ICON_REGISTRY.set(key, iconNode)
	}
}

/**
 * Collection of icon nodes used across the Astra project.
 * Each icon is registered with a set of flexible aliases to cover existing usages.
 * @type {[IconNode, string[]][]}
 */
const ICON_DEFINITIONS = [
	[BrainIconNode, ['brain']],
	[Settings2IconNode, ['settings-2', 'settings2']],
	[SettingsIconNode, ['settings']],
	[MessageCircleIconNode, ['message-circle']],
	[UsersIconNode, ['users']],
	[HouseIconNode, ['house', 'home']],
	[SlidersHorizontalIconNode, ['sliders-horizontal']],
	[Plug2IconNode, ['plug-2', 'plug2']],
	[PowerOffIconNode, ['power-off', 'poweroff', 'power']],
	[TypeIconNode, ['type']],
	[ChevronsLeftIconNode, ['chevrons-left']],
	[SmilePlusIconNode, ['smile-plus']],
	[ScanFaceIconNode, ['scan-face']],
	[InfoIconNode, ['info']],
	[CaseSensitiveIconNode, ['case-sensitive']],
	[WholeWordIconNode, ['whole-word']],
	[UserCogIconNode, ['user-cog']],
	[UserPenIconNode, ['user-pen']],
	[BookmarkIconNode, ['bookmark']],
	[ReplaceIconNode, ['replace']],
	[ReplaceAllIconNode, ['replace-all']],
	[TextSearchIconNode, ['text-search']],
	[CircleArrowUpIconNode, ['circle-arrow-up']],
	[CircleArrowDownIconNode, ['circle-arrow-down']],
	[AsteriskIconNode, ['asterisk']],
	[BellRingIconNode, ['bell-ring']],
	[TagsIconNode, ['tags']],
	[MessagesSquareIconNode, ['messages-square']],
	[ContactIconNode, ['contact']],
	[TextAlignJustifyIconNode, ['text-align-justify']],
	[MessageCircleMoreIconNode, ['message-circle-more']],
	[Trash2IconNode, ['trash-2', 'trash2']],
	[PencilLineIconNode, ['pencil-line']],
	[ImageIconNode, ['image']],
	[FlaskConicalIconNode, ['flask-conical']],
	[StickyNoteIconNode, ['sticky-note']],
	[WrenchIconNode, ['wrench']],
	[DatabaseZapIconNode, ['database-zap']],
	[ChevronRightIconNode, ['chevron-right']],
	[UploadIconNode, ['upload']],
	[BracesIconNode, ['braces']],
	[ArrowRightLeftIconNode, ['arrow-right-left']],
	[SparkleIconNode, ['sparkle']],
	[SquareCheckBigIconNode, ['square-check-big']],
	[IdCardLanyardIconNode, ['id-card-lanyard']],
	[BookLockIconNode, ['book-lock']],
	[ImagesIconNode, ['images']],
	[ExpandIconNode, ['expand']],
	[MinimizeIconNode, ['minimize']],
	[BookMarkedIconNode, ['book-marked']],
	[CircleCheckBigIconNode, ['circle-check-big']],
	[CircleFadingArrowUpIconNode, ['circle-fading-arrow-up']],
	[EllipsisIconNode, ['ellipsis']],
	[ArrowLeftIconNode, ['arrow-left']],
	[DownloadIconNode, ['download', 'download-icon']],
	[TriangleAlertIconNode, ['triangle-alert']],
	[ShieldAlertIconNode, ['shield-alert']],
	[FileTextIconNode, ['file-text', 'file-text-icon']],
	[CheckIconNode, ['check']],
	[FolderPenIconNode, ['folder-pen']],
	[FolderXIconNode, ['folder-x']],
	[ArrowDown01IconNode, ['arrow-down-0-1', 'arrowdown01']],
	[ArrowDownAZIconNode, ['arrow-down-a-z', 'arrow-down-az']],
]

ICON_DEFINITIONS.forEach(([iconNode, aliases]) => registerIcon(iconNode, aliases))

/**
 * Resolves an icon definition by name or returns null if missing.
 * @param {string|IconNode|{ iconNode?: IconNode }} icon
 * @returns {IconNode|null}
 */
function resolveIcon(icon) {
	if (!icon) return null
	if (Array.isArray(icon)) return icon
	if (typeof icon === 'object' && Array.isArray(icon.iconNode)) return icon.iconNode
	if (typeof icon === 'function' && Array.isArray(icon.iconNode)) return icon.iconNode
	if (typeof icon !== 'string') return null
	const normalized = toRegistryKey(icon)
	return ICON_REGISTRY.get(normalized) ?? null
}

/**
 * Creates an SVGElement for the requested icon.
 * @param {string|IconNode|{ iconNode?: IconNode }} icon
 * @param {IconOptions} [options]
 * @returns {SVGElement|null}
 */
function createLucideIconElement(icon, options) {
	const iconNode = resolveIcon(icon)
	if (!iconNode) return null
	return buildSvgFromIconNode(iconNode, options)
}

/**
 * Returns serialized SVG markup for the requested icon.
 * @param {string|IconNode|{ iconNode?: IconNode }} icon
 * @param {IconOptions} [options]
 * @returns {string}
 */
function getLucideIconMarkup(icon, options) {
	const element = createLucideIconElement(icon, options)
	return element ? element.outerHTML : ''
}

/**
 * Convenience helper to clone an icon element to avoid accidental DOM re-use.
 * @param {string|IconNode|{ iconNode?: IconNode }} icon
 * @param {IconOptions} [options]
 * @returns {SVGElement|null}
 */
function cloneLucideIconElement(icon, options) {
	const element = createLucideIconElement(icon, options)
	return element ? element.cloneNode(true) : null
}

export {
	createLucideIconElement,
	cloneLucideIconElement,
	getLucideIconMarkup,
	resolveIcon as resolveLucideIcon,
}
